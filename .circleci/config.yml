---
version: 2.1
executors:
  default:
    docker:
      - image: circleci/golang:1.13
        user: root
    working_directory: /go/src/github.com/kancers/hello-grpc
jobs:
  setup:
    executor:
      name: default
    steps:
      - checkout
      - run:
          name: Get Cache Checksum
          command: ls -la backend/go.mod > deps_checksum
      - restore_cache:
          name: Restore go modules cache
          keys:
            - v1-go-mod-{{ .Branch }}-{{ checksum "deps_checksum" }}
      - run:
          name: download golangci-lint
          command: |
            curl -sfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh| sh -s v1.21.0
      - run:
          name: Vendoring
          command: cd ./backend && go mod download
      - save_cache:
          name: Save go modules cache
          key: v1-go-mod-{{ .Branch }}-{{ checksum "deps_checksum" }}
          paths:
            - /go/pkg/mod/cache
      - persist_to_workspace:
          root: /go
          paths:
            - src
            - bin
            - pkg/mod/cache

  go_test:
    executor:
      name: default
    steps:
      - attach_workspace:
          at: /go
      - run:
          name: Run test
          command: cd ./backend && make test

  go_lint:
    executor:
      name: default
    steps:
      - attach_workspace:
          at: /go
      - run:
          name: Run lint
          command: cd ./backend && make lint

workflows:
  test-and-lint:
    jobs:
      - setup
      - go_test:
          requires:
            - setup
      - go_lint:
          requires:
            - setup
